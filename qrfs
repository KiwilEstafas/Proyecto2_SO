#!/bin/bash

# colores
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

show_help() {
    echo -e "${BLUE}qrfs - quick response file system cli${NC}"
    echo "uso: ./qrfs <comando> [argumentos]"
    echo ""
    echo "comandos principales:"
    echo -e "  ${GREEN}mkfs${NC}     crear un sistema de archivos qrfs"
    echo "            uso: ./qrfs mkfs <qr_folder> [--blocks n]"
    echo ""
    echo -e "  ${GREEN}mount${NC}    montar el sistema de archivos"
    echo "            uso: ./qrfs mount <qr_folder> <mountpoint>"
    echo ""
    echo -e "  ${GREEN}fsck${NC}     chequeo de consistencia"
    echo "            uso: ./qrfs fsck <qr_folder>"
    echo ""
    echo "herramientas extra:"
    echo -e "  ${GREEN}server${NC}   iniciar lector qr (modo manual)"
    echo "            uso: ./qrfs server <carpeta_destino>"
    echo ""
    echo -e "  ${GREEN}scan${NC}     iniciar escaner qr (modo automatico)"
    echo "            uso: ./qrfs scan <carpeta_destino>"
    echo ""
    echo -e "  ${GREEN}qr${NC}       extraer qrs a imagenes"
    echo "            uso: ./qrfs qr <qr_folder> <id_inodo> --out <salida>"
    echo ""
    echo -e "  ${GREEN}clean${NC}    limpiar compilacion y montajes"
    echo ""
}

get_local_ip() {
    # obtener ip local de la maquina
    local ip=$(ip route get 1 | awk '{print $7}' | head -n1)
    if [ -z "$ip" ]; then
        ip=$(hostname -I | awk '{print $1}')
    fi
    echo "$ip"
}

if [ -z "$1" ]; then
    show_help
    exit 1
fi

SUBCOMMAND=$1
shift

case "$SUBCOMMAND" in
    mkfs)
        RUST_LOG=info cargo run --quiet --bin mkfs -- "$@"
        ;;
    mount)
        echo -e "${BLUE}montando qrfs... (ctrl+c para salir)${NC}"
        RUST_LOG=info cargo run --quiet --bin mount -- "$@"
        ;;
    fsck)
        RUST_LOG=info cargo run --quiet --bin fsck -- "$@"
        ;;
    server)
        echo -e "${BLUE}iniciando servidor lector (modo manual)...${NC}"
        LOCAL_IP=$(get_local_ip)
        echo -e "${YELLOW}abre en tu celular:${NC}"
        echo -e "  http://${LOCAL_IP}:8080/"
        echo ""
        RUST_LOG=info cargo run --quiet --bin server -- "$@"
        ;;
    scan)
        echo -e "${BLUE}iniciando escaner qr (modo automatico)...${NC}"
        LOCAL_IP=$(get_local_ip)
        echo -e "${YELLOW}abre en tu celular:${NC}"
        echo -e "  ${GREEN}http://${LOCAL_IP}:8080/scanner${NC}"
        echo ""
        echo -e "${YELLOW}instrucciones:${NC}"
        echo "  1. apunta la camara a cada codigo qr impreso"
        echo "  2. el sistema detecta automaticamente el id del bloque"
        echo "  3. los bloques duplicados se ignoran"
        echo "  4. presiona 'pausar' si necesitas descansar"
        echo ""
        RUST_LOG=info cargo run --quiet --bin server -- "$@"
        ;;
    qr|extract)
        RUST_LOG=info cargo run --quiet --bin qr_extract -- "$@"
        ;;
    clean)
        echo -e "${BLUE}limpiando entorno...${NC}"
        fusermount -uz mnt 2>/dev/null
        cargo clean
        echo -e "${GREEN}listo.${NC}"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        echo -e "${RED}error: comando '$SUBCOMMAND' desconocido.${NC}"
        show_help
        exit 1
        ;;
esac